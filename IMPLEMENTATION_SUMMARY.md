# âœ… å®ç°æ€»ç»“ - Quadrants Todo with Neon Auth + RLS + Stripe

## ğŸ¯ å·²å®Œæˆçš„åŠŸèƒ½

### 1. è®¤è¯ç³»ç»Ÿ (Stack Auth / Neon Auth)

**æ–‡ä»¶:**
- `lib/stack-server.ts` - æœåŠ¡ç«¯è®¤è¯é€»è¾‘
- `lib/stack-client.tsx` - å®¢æˆ·ç«¯è®¤è¯ Provider
- `app/handler/[...stack]/page.tsx` - è®¤è¯è·¯ç”±å¤„ç†å™¨
- `app/layout.tsx` - åº”ç”¨å¸ƒå±€ï¼ˆåŒ…å« StackProviderï¼‰
- `middleware.ts` - è·¯ç”±ä¿æŠ¤ä¸­é—´ä»¶

**åŠŸèƒ½:**
- âœ… ç”¨æˆ·æ³¨å†Œ (`/handler/sign-up`)
- âœ… ç”¨æˆ·ç™»å½• (`/handler/sign-in`)
- âœ… ä¼šè¯ç®¡ç†ï¼ˆåŸºäº Cookieï¼‰
- âœ… è‡ªåŠ¨é‡å®šå‘åˆ°ç™»å½•é¡µ
- âœ… è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯

### 2. Row-Level Security (RLS)

**æ–‡ä»¶:**
- `scripts/enable-rls.sql` - å®Œæ•´çš„ RLS ç­–ç•¥ SQL è„šæœ¬

**å®ç°çš„è¡¨å’Œç­–ç•¥:**

#### è¡¨ç»“æ„
- âœ… `users` - ç”¨æˆ·è¡¨ï¼ˆåŒæ­¥è‡ª Stack Authï¼‰
- âœ… `projects` - é¡¹ç›®è¡¨ï¼ˆæ”¯æŒæ‰€æœ‰æƒï¼‰
- âœ… `project_members` - é¡¹ç›®æˆå‘˜è¡¨ï¼ˆæ”¯æŒå›¢é˜Ÿåä½œï¼‰
- âœ… `tasks`, `players`, `task_lines` - æ·»åŠ  `project_id` å­—æ®µ

#### RLS ç­–ç•¥
- âœ… **users è¡¨**: ç”¨æˆ·åªèƒ½è¯»å†™è‡ªå·±çš„æ•°æ®
- âœ… **projects è¡¨**:
  - ç”¨æˆ·å¯ä»¥æŸ¥çœ‹è‡ªå·±æ‹¥æœ‰æˆ–å‚ä¸çš„é¡¹ç›®
  - åªæœ‰æ‰€æœ‰è€…å¯ä»¥æ›´æ–°/åˆ é™¤é¡¹ç›®
- âœ… **project_members è¡¨**:
  - æ‰€æœ‰è€…å’Œç®¡ç†å‘˜å¯ä»¥æ·»åŠ /åˆ é™¤æˆå‘˜
- âœ… **tasks, players, task_lines è¡¨**:
  - åŸºäºé¡¹ç›®æˆå‘˜å…³ç³»çš„è®¿é—®æ§åˆ¶
  - ç»§æ‰¿é¡¹ç›®çš„æƒé™ç­–ç•¥

#### æ€§èƒ½ä¼˜åŒ–
- âœ… åˆ›å»ºäº†æ‰€æœ‰å¿…è¦çš„ç´¢å¼•
- âœ… `set_current_user_id()` å‡½æ•°ç”¨äºè®¾ç½®ç”¨æˆ·ä¸Šä¸‹æ–‡

### 3. Stripe è®¢é˜…ç³»ç»Ÿ

**æ–‡ä»¶:**
- `lib/stripe.ts` - Stripe SDK å°è£…å’Œè®¢é˜…è®¡åˆ’é…ç½®
- `app/api/stripe/webhook/route.ts` - Stripe Webhook å¤„ç†å™¨
- `app/api/stripe/create-checkout-session/route.ts` - åˆ›å»ºæ”¯ä»˜ä¼šè¯
- `app/api/stripe/create-portal-session/route.ts` - å®¢æˆ·é—¨æˆ·ä¼šè¯
- `app/pricing/page.tsx` - å®šä»·é¡µé¢

**è®¢é˜…è®¡åˆ’:**

1. **Free Plan**
   - 1 ä¸ªé¡¹ç›®
   - 1 ä¸ªæˆå‘˜
   - æ— é™ä»»åŠ¡

2. **Pro Plan ($12/æœˆ æˆ– $120/å¹´)**
   - 10 ä¸ªé¡¹ç›®
   - 5 ä¸ªå›¢é˜Ÿæˆå‘˜
   - ä¼˜å…ˆæ”¯æŒ
   - æ•°æ®å¯¼å‡º

3. **Team Plan ($29/æœˆ æˆ– $290/å¹´)**
   - æ— é™é¡¹ç›®
   - æ— é™å›¢é˜Ÿæˆå‘˜
   - 24/7 æ”¯æŒ
   - é«˜çº§åŠŸèƒ½

**Webhook äº‹ä»¶å¤„ç†:**
- âœ… `checkout.session.completed` - è®¢é˜…åˆ›å»º
- âœ… `customer.subscription.updated` - è®¢é˜…æ›´æ–°
- âœ… `customer.subscription.deleted` - è®¢é˜…å–æ¶ˆ
- âœ… `invoice.payment_succeeded` - æ”¯ä»˜æˆåŠŸ
- âœ… `invoice.payment_failed` - æ”¯ä»˜å¤±è´¥

**åŠŸèƒ½:**
- âœ… åˆ›å»º Stripe Checkout ä¼šè¯
- âœ… å®¢æˆ·é—¨æˆ·ï¼ˆç®¡ç†è®¢é˜…ã€æ›´æ–°æ”¯ä»˜æ–¹å¼ï¼‰
- âœ… è®¢é˜…çŠ¶æ€åŒæ­¥åˆ°æ•°æ®åº“
- âœ… æ ¹æ®è®¢é˜…é™åˆ¶é¡¹ç›®å’Œæˆå‘˜æ•°é‡

### 4. ç¯å¢ƒé…ç½®

**æ–‡ä»¶:**
- `.env.local` - ç¯å¢ƒå˜é‡é…ç½®
- `lib/env.ts` - ç¯å¢ƒå˜é‡ç±»å‹å®šä¹‰

**é…ç½®é¡¹:**
\`\`\`bash
DATABASE_URL                              # Neon æ•°æ®åº“è¿æ¥
NEXT_PUBLIC_STACK_PROJECT_ID              # Stack Auth é¡¹ç›® ID
NEXT_PUBLIC_STACK_PUBLISHABLE_CLIENT_KEY  # Stack Auth å…¬é’¥
STACK_SECRET_SERVER_KEY                   # Stack Auth å¯†é’¥
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY        # Stripe å…¬é’¥
STRIPE_SECRET_KEY                         # Stripe å¯†é’¥
STRIPE_WEBHOOK_SECRET                     # Stripe Webhook å¯†é’¥
STRIPE_PRICE_ID_PRO_MONTHLY               # Pro æœˆä»˜ä»·æ ¼ ID
STRIPE_PRICE_ID_PRO_YEARLY                # Pro å¹´ä»˜ä»·æ ¼ ID
STRIPE_PRICE_ID_TEAM_MONTHLY              # Team æœˆä»˜ä»·æ ¼ ID
STRIPE_PRICE_ID_TEAM_YEARLY               # Team å¹´ä»˜ä»·æ ¼ ID
\`\`\`

## ğŸ“ æ–°å¢æ–‡ä»¶åˆ—è¡¨

\`\`\`
lib/
â”œâ”€â”€ stack-server.ts          # Stack Auth æœåŠ¡ç«¯
â”œâ”€â”€ stack-client.tsx         # Stack Auth å®¢æˆ·ç«¯
â”œâ”€â”€ stripe.ts                # Stripe é›†æˆ
â””â”€â”€ env.ts                   # ç¯å¢ƒå˜é‡ï¼ˆå·²æ›´æ–°ï¼‰

app/
â”œâ”€â”€ handler/
â”‚   â””â”€â”€ [...stack]/
â”‚       â””â”€â”€ page.tsx         # è®¤è¯è·¯ç”±
â”œâ”€â”€ pricing/
â”‚   â””â”€â”€ page.tsx             # å®šä»·é¡µé¢
â””â”€â”€ api/
    â””â”€â”€ stripe/
        â”œâ”€â”€ webhook/
        â”‚   â””â”€â”€ route.ts     # Stripe Webhook
        â”œâ”€â”€ create-checkout-session/
        â”‚   â””â”€â”€ route.ts     # åˆ›å»ºæ”¯ä»˜ä¼šè¯
        â””â”€â”€ create-portal-session/
            â””â”€â”€ route.ts     # å®¢æˆ·é—¨æˆ·

scripts/
â””â”€â”€ enable-rls.sql           # RLS ç­–ç•¥ SQL

middleware.ts                # è·¯ç”±ä¿æŠ¤ï¼ˆå·²æ›´æ–°ï¼‰
SETUP.md                     # å®Œæ•´è®¾ç½®æŒ‡å—
IMPLEMENTATION_SUMMARY.md    # æœ¬æ–‡ä»¶
\`\`\`

## ğŸ”§ ä¸‹ä¸€æ­¥æ“ä½œ

### å¿…é¡»å®Œæˆçš„æ­¥éª¤ï¼ˆæŒ‰é¡ºåºï¼‰:

1. **åˆ›å»º Neon é¡¹ç›®å¹¶å¯ç”¨ Auth**
   \`\`\`bash
   # è®¿é—® https://pg.new
   # å¯ç”¨ Neon Auth
   # è·å–æ‰€æœ‰å¿…éœ€çš„ç¯å¢ƒå˜é‡
   \`\`\`

2. **æ‰§è¡Œæ•°æ®åº“è¿ç§»**
   \`\`\`bash
   psql $DATABASE_URL < scripts/enable-rls.sql
   \`\`\`

3. **é…ç½® Stripe**
   \`\`\`bash
   # åˆ›å»ºäº§å“å’Œä»·æ ¼
   # é…ç½® Webhook
   # è·å–æ‰€æœ‰ API å¯†é’¥
   \`\`\`

4. **æ›´æ–° `.env.local`**
   \`\`\`bash
   # å¡«å…¥æ‰€æœ‰å®é™…çš„ç¯å¢ƒå˜é‡å€¼
   \`\`\`

5. **æœ¬åœ°æµ‹è¯•**
   \`\`\`bash
   npm install
   npm run dev

   # åœ¨å¦ä¸€ä¸ªç»ˆç«¯
   stripe listen --forward-to localhost:3000/api/stripe/webhook
   \`\`\`

6. **æµ‹è¯•æµç¨‹**
   - æ³¨å†Œæ–°ç”¨æˆ·
   - è®¿é—®å®šä»·é¡µé¢
   - ä½¿ç”¨æµ‹è¯•å¡ (4242 4242 4242 4242) å®Œæˆæ”¯ä»˜
   - éªŒè¯è®¢é˜…çŠ¶æ€
   - æµ‹è¯•æ•°æ®éš”ç¦»

## ğŸ¨ ç³»ç»Ÿæ¶æ„

\`\`\`
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ç”¨æˆ·æµè§ˆå™¨                             â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  æ³¨å†Œ/ç™»å½•    â”‚    â”‚  å®šä»·é¡µé¢     â”‚    â”‚  é¡¹ç›®ç®¡ç†     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Next.js Middleware                        â”‚
â”‚                    (è®¤è¯ & è·¯ç”±ä¿æŠ¤)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â†“                â†“                â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Stack Auth  â”‚  â”‚ Stripe API   â”‚  â”‚ Neon DB      â”‚
    â”‚  (Neon Auth) â”‚  â”‚              â”‚  â”‚ (with RLS)   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                  â”‚                 â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   æ•°æ®åŒæ­¥         â”‚
                    â”‚ - ç”¨æˆ·ä¿¡æ¯         â”‚
                    â”‚ - è®¢é˜…çŠ¶æ€         â”‚
                    â”‚ - é¡¹ç›®æƒé™         â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
\`\`\`

## ğŸ”’ å®‰å…¨ç‰¹æ€§

- âœ… Row-Level Security è‡ªåŠ¨è¿‡æ»¤æ•°æ®
- âœ… Stripe Webhook ç­¾åéªŒè¯
- âœ… Cookie-based ä¼šè¯ç®¡ç†
- âœ… ä¸­é—´ä»¶è·¯ç”±ä¿æŠ¤
- âœ… HTTPS only in production
- âœ… SQL æ³¨å…¥é˜²æŠ¤ï¼ˆä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢ï¼‰
- âœ… ç¯å¢ƒå˜é‡éš”ç¦»

## ğŸ“Š æ•°æ®æµ

### 1. ç”¨æˆ·æ³¨å†Œæµç¨‹
\`\`\`
ç”¨æˆ· â†’ /handler/sign-up â†’ Stack Auth â†’ users è¡¨ â†’ å®Œæˆ
\`\`\`

### 2. è®¢é˜…æµç¨‹
\`\`\`
ç”¨æˆ· â†’ /pricing â†’ é€‰æ‹©è®¡åˆ’ â†’ Stripe Checkout â†’
â†’ æ”¯ä»˜æˆåŠŸ â†’ Webhook â†’ æ›´æ–° users.subscription_status â†’ å®Œæˆ
\`\`\`

### 3. æ•°æ®è®¿é—®æµç¨‹
\`\`\`
è¯·æ±‚ â†’ Middleware (éªŒè¯ç™»å½•) â†’
â†’ è®¾ç½® app.current_user_id â†’
â†’ RLS ç­–ç•¥è¿‡æ»¤ â†’
â†’ è¿”å›ä»…ç”¨æˆ·æœ‰æƒè®¿é—®çš„æ•°æ®
\`\`\`

## ğŸ› å·²çŸ¥é—®é¢˜å’Œå¾…ä¼˜åŒ–

### å¾…å®ç°åŠŸèƒ½
- [ ] æ›´æ–°ç°æœ‰çš„æ•°æ®åº“å‡½æ•°ä»¥ä½¿ç”¨ RLS
- [ ] æ·»åŠ è®¢é˜…é™åˆ¶æ£€æŸ¥ï¼ˆé¡¹ç›®/æˆå‘˜æ•°é‡ï¼‰
- [ ] å®ç°é¡¹ç›®é‚€è¯·ç³»ç»Ÿ
- [ ] æ·»åŠ é‚®ä»¶é€šçŸ¥ï¼ˆè®¢é˜…ç¡®è®¤ã€æ”¯ä»˜å¤±è´¥ç­‰ï¼‰
- [ ] å®ç°æ•°æ®å¯¼å‡ºåŠŸèƒ½ï¼ˆPro/Team åŠŸèƒ½ï¼‰
- [ ] æ·»åŠ ä½¿ç”¨åˆ†æï¼ˆTeam åŠŸèƒ½ï¼‰

### å»ºè®®ä¼˜åŒ–
- [ ] æ·»åŠ  Redis ç¼“å­˜ç”¨æˆ·è®¢é˜…çŠ¶æ€
- [ ] å®ç° webhook é‡è¯•æœºåˆ¶
- [ ] æ·»åŠ è¯¦ç»†çš„æ—¥å¿—å’Œç›‘æ§
- [ ] å®ç° rate limiting
- [ ] æ·»åŠ å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•

## ğŸ“ é‡è¦æç¤º

1. **ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å‰**:
   - å°†æ‰€æœ‰ `pk_test_` å’Œ `sk_test_` æ›¿æ¢ä¸ºç”Ÿäº§å¯†é’¥
   - é…ç½®ç”Ÿäº§ç¯å¢ƒ Stripe Webhook
   - å¯ç”¨ HTTPS
   - è®¾ç½®é€‚å½“çš„ CORS ç­–ç•¥

2. **æ•°æ®åº“ç»´æŠ¤**:
   - å®šæœŸå¤‡ä»½æ•°æ®åº“
   - ç›‘æ§ RLS ç­–ç•¥æ€§èƒ½
   - æ ¹æ®éœ€è¦æ·»åŠ æ–°ç´¢å¼•

3. **Stripe æœ€ä½³å®è·µ**:
   - ä½¿ç”¨ Stripe CLI æµ‹è¯•æœ¬åœ° webhook
   - ç›‘æ§ webhook å¤±è´¥å¹¶å®ç°é‡è¯•
   - è®¾ç½®è´¦å•æé†’

## ğŸ‰ ç»“è®º

ä½ ç°åœ¨æ‹¥æœ‰ä¸€ä¸ªå®Œæ•´çš„ SaaS åº”ç”¨æ¶æ„ï¼š
- âœ… å®‰å…¨çš„ç”¨æˆ·è®¤è¯ï¼ˆStack Authï¼‰
- âœ… æ•°æ®éš”ç¦»å’Œæƒé™æ§åˆ¶ï¼ˆRLSï¼‰
- âœ… è®¢é˜…ä»˜è´¹ç³»ç»Ÿï¼ˆStripeï¼‰
- âœ… å›¢é˜Ÿåä½œåŠŸèƒ½
- âœ… å¯æ‰©å±•çš„æ¶æ„

å‚è€ƒ `SETUP.md` å®Œæˆæœ€ç»ˆé…ç½®å¹¶å¼€å§‹ä½¿ç”¨ï¼
